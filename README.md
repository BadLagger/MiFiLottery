swagger - http://localhost:8080/swagger-ui.html

# MiFiLottery
Проектная практика МИФИ, магистратура

## Общие требования

**Цель:**

Создание системы для проведения лотерейных тиражей с возможностью покупки билетов, определения выигрышей и интеграции с платежными системами.

**Язык программирования:** 

Java 17+. 

Фрейворк: Spring Boot 3.x


**База данных:** 

PostgreSQL 17

Архитектура: Монолит с четким разделением слоев: Controller → Service → Repository.

Безопасность: Аутентификация через JWT-токены.

Роли пользователей: USER - покупка билетов, проверка результатов, ADMIN - управление тиражами, играми, отмена тиражей.


## Основные компоненты системы


**Тиражная служба (Draw Service)**

Описание: Тиражная служба управляет лотерейными тиражами, их статусами и расписанием. Она отвечает за создание, изменение и отмену тиражей, а также за автоматическое определение результатов.

*Сущности:*

Draw (Тираж): 
* id (уникальный идентификатор).
* lotteryType (тип лотереи, например, "5 из 36").
* startTime (дата и время начала тиража).
* status (статус: PLANNED, ACTIVE, COMPLETED, CANCELLED).

DrawResult (Результат тиража):
* id.
* drawId (ссылка на тираж).
* winningCombination (выигрышная комбинация чисел).
* resultTime (время определения результатов).

*API:*
* POST /api/admin/draws (только ADMIN): Создание тиража с указанием типа лотереи и времени старта.
* GET /api/draws/active: Получение списка активных тиражей.
* PUT /api/admin/draws/{id}/cancel (только ADMIN): Отмена тиража (изменение статуса на CANCELLED).

*Логика:*
* Автоматический переход статусов:
* При наступлении startTime статус меняется с PLANNED на ACTIVE.
* По завершении времени тиража статус меняется на COMPLETED, запускается алгоритм определения выигрышей.
* При отмене тиража все связанные билеты помечаются как недействительные.
* Добавьте возможность просматривать историю завершенных тиражей
* API для получения информации о предыдущих тиражах и их результатах.

**Служба генерации билетов (Ticket Service)**

Описание: Служба генерации билетов отвечает за создание билетов для участия в тиражах. Поддержка двух режимов генерации:
* Предсозданные билеты: Система генерирует билеты автоматически (для лотерей, где выбор чисел запрещен).
* Пользовательский выбор: Пользователь самостоятельно выбирает числа (например, для лотереи "5 из 36").

*Сущности:*

Ticket (Билет):
* id.
* userId (идентификатор пользователя).
* drawId (идентификатор тиража).
* Data описание данных «ставки» билета
* status (статус: PENDING, WIN, LOSE).

*API:*
* GET /api/tickets/{id} (только USER): Получение информации о билете (числа, статус, тираж).

*Логика:*
* Валидация чисел:
  - Для лотереи "5 из 36": 5 уникальных чисел в диапазоне 1–36.
  - При невалидных данных возвращается ошибка 400 Bad Request.
  - При создании билета проверяется, что тираж в статусе ACTIVE.
* Добавьте возможность пользователям просматривать историю своих билетов и их статусы.
* GET /api/tickets API для получения списка всех билетов пользователя с учетом тиражной информации.

**Шлюз оплаты (Payment Service)**

Описание: Шлюз оплаты отвечает за обработку платежей за покупку билетов с интеграцией с mock-платежной системой.

*Сущности:*

Invoice (инвойс):
* Id.
* TicketData данные по билету.
* registerTime – время регистрации.
* status – регистрации.

Payment (Платеж):
* id.
* amount (сумма платежа).
* status (SUCCESS, FAILED).
* paymentTime (время выполнения платежа).

*API:*
* POST /api/invoice - зарегестрировать invoice. Параметры: Invoice – инвойс к регистрации, Осуществляет регистрацию инвойса
* POST /api/payments - зарегестрировать платёж (только USER). Параметры: cardNumber (номер карты), cvc (CVC-код). Симулирует успешную (80%) или неудачную (20%) оплату.

*Логика (для тестовой среды):*
* Любой номер карты принимается, если CVC = 123.
* При успешной оплате билет привязывается к пользователю.
* При неудаче билет не создается.

**Служба определения результатов (Draw Result Service)**

Описание: Служба определения результатов отвечает за генерацию выигрышных комбинаций и обновление статусов билетов.

*Сущности:*

Отсутствуют

*API:*
* GET /api/draws/{id}/results: Получение выигрышной комбинации тиража.
* GET /api/tickets/{id}/check-result (только USER): Проверка результата билета.


*Логика:*
* После завершения тиража (status = COMPLETED):
* Генерация выигрышной комбинации с использованием SecureRandom.
* Сравнение чисел билетов с выигрышной комбинацией.
* Обновление статусов билетов (WIN/LOSE).
* Добавьте возможность пользователям просматривать историю своих билетов и их статусы.

*Алгоритмы для разных типов лотерей:*
* Лотереи с предсозданными билетами: Проверка полного совпадения чисел.
* Лотереи с выбором пользователя: Проверка частичного совпадения (например, 3 из 5 чисел).

**Служба выгрузки данных (Export Service)**

Описание:
Формирование отчетов по завершенным тиражам и начисление выигрышей.

*Сущности:*

Отсутствуют

*API:*

Отсутствует

*Логика:*

После определения результатов тиража:
* Начисление выигрышей на счета пользователей (симуляция).
* Выгрузка данных о выигрышных билетах в формате CSV/JSON.
* Отчет должен содержать:
  - Идентификатор тиража.
  - Выигрышную комбинацию.
  - Список выигравших билетов с суммами.
* Добавьте возможность выгрузки статистики по пользователям, выигрышам и тиражам в виде отчетов (например, по месяцам) в формате csv/json

## Нефункциональные требования ##

**Производительность:**
* Время ответа API не более 0.5 секунды.
* Поддержка до 1000 запросов в секунду
  
**Безопасность:**
* Данные платежей (карты) не хранятся в системе.
* JWT-токены с сроком действия 1 час.

**Логирование:**
* Уровни логирования:
  - INFO: Регистрация создания тиражей, успешных платежей.
  - WARN: Попытки доступа к запрещенным ресурсам.
  - ERROR: Сбои при оплате, ошибки генерации результатов.
* Формат логов:
  - JSON-логи для интеграции с системами мониторинга (ELK, Grafana Loki).
  - Обязательные поля: timestamp, service, level, message, user_id (если есть).
* Ротация логов:
  - Настройка ежедневной ротации лог-файлов с архивированием (например, через Logback).

**Масштабируемость:**
* Возможность расширения для новых типов лотерей.

## Интерфейсы ##

**REST API:**
* Формат запросов/ответов: JSON.
  
**База данных:**
* Схема должна быть нормализована (2NF).
* Индексы для ускорения поиска по drawId, userId, status.

## Уведомления ##

**Интеграция с мессенджерами или с почтой:**
* Отправка результатов тиражей через Telegram Bot API.
* Email-уведомления: Шаблоны писем для победителей (например, через SendGrid).
* Уведомления администраторов о критических ошибках.

## Тестирование ##

* Интеграционные тесты: Проверка работы всех API-эндпоинтов insomnia\postman.
  
**Сценарии:**

* Покупка билета с успешной/неудачной оплатой.
* Отмена тиража с проверкой статусов билетов.
* Генерация выигрышной комбинации для разных типов лотерей.
* Вывод всех билетов пользователя

## Дополнительные требования ##

**Деплой:**

* Развертывание в Docker-контейнере.
* Настройка подключения к PostgreSQL через переменные окружения.

**Документация:**

* README с инструкцией по запуску и примеры запросов.

*Примечание: Выбор между Spring Boot и встроенным HTTP-сервером остается за разработчиком. Архитектура должна обеспечивать модульность и легкость поддержки.*

## Дополнительные функции ##

**История операций:**

* Эндпоинт /api/users/me/history для просмотра покупок и выигрышей.

**Возврат средств:**

* API для отмены билета (если тираж отменен).
 
**Реферальная система:**

* Бонусы за приглашение друзей (опционально).
